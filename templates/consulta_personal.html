{% extends 'base.html' %}

{% block title %}Personal registrado{% endblock %}

{% block content %}

<a href="{{ url_for('delegaciones_bp.vista_ccts_por_delegacion', delegacion_id=delegacion.id) }}" class="btn btn-secondary mb-3">
  ‚¨ÖÔ∏è Regresar a CCTs
</a>


<h4 class="mb-2">
  Personal en el plantel <strong>{{ plantel.nombre }}</strong> ({{ plantel.cct }})
</h4>

<p class="mb-1">
  <strong>Direcci√≥n:</strong>
  {{ plantel.calle or '' }} {{ plantel.num_exterior or '' }}{{ ' Int. ' + plantel.num_interior if plantel.num_interior else '' }},
  {{ plantel.colonia or '' }}, {{ plantel.municipio or '' }}, C.P. {{ plantel.cp or '' }}
</p>

{% if plantel.coordenadas_gps %}
<p>
  <a href="https://www.google.com/maps/search/?api=1&query={{ plantel.coordenadas_gps }}" target="_blank" class="btn btn-sm btn-outline-success">
    üìç Ver en Google Maps
  </a>
</p>
{% endif %}


{% with mensajes = get_flashed_messages(with_categories=true) %}
  {% if mensajes %}
    {% for categoria, mensaje in mensajes %}
      <div class="alert alert-{{ categoria }} alert-dismissible fade show animate__animated animate__fadeIn" role="alert">
        {{ mensaje }}
        <button class="btn-close" data-bs-dismiss="alert" type="button"></button>
</div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if has_role('admin') %}
<div class="mb-4 d-flex flex-wrap gap-2">
  <a class="btn btn-outline-primary" href="{{ url_for('static', filename='plantillas/plantilla_personal.xlsx') }}">
    üì• Descargar plantilla Excel
  </a>
  <form action="{{ url_for('personal_bp.subir_excel_personal', cct=plantel.cct) }}"
        class="d-flex align-items-center gap-2"
        enctype="multipart/form-data"
        method="POST">
    <input accept=".xlsx" class="form-control" name="archivo_excel" required type="file"/>
    <button class="btn btn-success" type="submit">üì§ Subir Excel</button>
  </form>
</div>
{% endif %}

<div class="mb-4">
<button class="btn btn-primary" data-bs-target="#modal-nuevo-personal" data-bs-toggle="modal">
    ‚ûï Agregar personal
  </button>
</div>

<!-- ‚úÖ Reportes DETALLADOS de Personal por este CCT -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <a href="{{ url_for('personal_bp.reporte_personal_cct_excel', cct=plantel.cct) }}"
     class="btn btn-outline-success">
    üë• Exportar PERSONAL (detalle CCT) ‚Äî Excel
  </a>
  <a href="{{ url_for('personal_bp.reporte_personal_cct_pdf', cct=plantel.cct) }}"
     class="btn btn-outline-danger">
    üë• Exportar PERSONAL (detalle CCT) ‚Äî PDF
  </a>
</div>


<div aria-hidden="true" class="modal fade" id="modal-nuevo-personal" tabindex="-1">
<div class="modal-dialog modal-xl modal-dialog-centered">
<div class="modal-content">
<form action="{{ url_for('personal_bp.agregar_personal_manual', cct=plantel.cct) }}" method="POST">
<div class="modal-header">
<h5 class="modal-title">Agregar personal</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row g-2">
            {% for label, name, type, required in [
              ('Apellido paterno', 'apellido_paterno', 'text', true),
              ('Apellido materno', 'apellido_materno', 'text', true),
              ('Nombre(s)', 'nombre', 'text', true),
              ('G√©nero', 'genero', 'select', true),
              ('RFC', 'rfc', 'text', true),
              ('CURP', 'curp', 'text', true),
              ('Clave presupuestal', 'clave_presupuestal', 'text', false),
              ('Funci√≥n', 'funcion', 'text', true),
              ('Grado m√°ximo de estudios', 'grado_estudios', 'text', false),
              ('Titulado', 'titulado', 'selectTit', false),
              ('Fecha de ingreso', 'fecha_ingreso', 'date', false),
              ('Fecha baja por jubilaci√≥n', 'fecha_baja_jubilacion', 'date', false),
              ('Estatus de membres√≠a', 'estatus_membresia', 'selectEst', false),
              ('Nombramiento', 'nombramiento', 'text', false),
              ('Domicilio', 'domicilio', 'text', false),
              ('N√∫mero', 'numero', 'text', false),
              ('Localidad', 'localidad', 'text', false),
              ('Colonia', 'colonia', 'text', false),
              ('Municipio', 'municipio', 'text', false),
              ('C.P.', 'cp', 'text', false),
              ('Tel√©fono 1', 'tel1', 'text', false),
              ('Tel√©fono 2', 'tel2', 'text', false),
              ('Correo electr√≥nico', 'correo_electronico', 'email', false)
            ] %}
              <div class="col-md-4">
<label class="form-label">{{ label }}</label>
                {% if type == 'select' %}
                  <select class="form-select" name="{{ name }}" required="">
<option value="">Seleccionar</option>
<option value="H">H</option>
<option value="M">M</option>
</select>
                {% elif type == 'selectTit' %}
                  <select class="form-select" name="{{ name }}">
<option value="">Seleccionar</option>
<option value="T√çTULO">T√çTULO</option>
<option value="NO TITUTLADO">NO TITULADO</option>
<option value="N/A">N/A</option>
</select>
                {% elif type == 'selectEst' %}
                  <select class="form-select" name="{{ name }}">
<option value="">Seleccionar</option>
<option value="ACTIVO">ACTIVO</option>
<option value="INACTIVO">INACTIVO</option>
</select>
                {% else %}
                  <input type="{{ type }}" name="{{ name }}" class="form-control" {% if required %}required{% endif %}>
                {% endif %}
              </div>
            {% endfor %}
          </div>
</div>
<div class="modal-footer">
<button class="btn btn-success" type="submit">Guardar</button>
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
</div>
</form>
</div>
</div>
</div>
<style>
.card-personal {
  border: 1px solid #dee2e6;
  border-radius: 0.5rem;
  padding: 1rem;
  position: relative;
  transition: box-shadow 0.3s;
  width: 100%;
}
.card-personal:hover {
  box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.15);
}
.card-actions {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
}
.card-actions .btn-sm {
  visibility: hidden;
}
.card-personal:hover .card-actions .btn-sm {
  visibility: visible;
}
/* Amarillo cuando est√° en baja en proceso */
.card-warning {
  background-color: #fff3cd;
  border-color: #ffeeba;
}
/* Badge pegado a la esquina inferior derecha de la tarjeta */
.status-chip {
  position: absolute;
  right: .5rem;
  bottom: .5rem;
  z-index: 2;
  pointer-events: none; /* no tapa clics a botones cercanos */
}

</style>
<div class="row row-cols-1 row-cols-md-2 g-3">
  {% for persona in personal %}
  <div class="col">
<div class="card-personal {% if persona.estatus_membresia == 'BAJA EN PROCESO' %}card-warning{% endif %}">
<div class="d-flex justify-content-between align-items-center">
<a class="fw-bold text-decoration-none" href="{{ url_for('personal_bp.vista_detalle_personal', id=persona.id) }}" style="color: #f37021 !important;">
          {{ persona.apellido_paterno }} {{ persona.apellido_materno }} {{ persona.nombre }}
        </a>
<div class="card-actions">
    {# Badge de estado #}

    {# Bot√≥n Solicitar Baja (roles autorizados para pedirla) #}
    {% if has_role('admin', 'coordinador', 'delegado', 'secretario') %}
      <button
        type="button"
        class="btn btn-outline-warning btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#modal-solicitar-baja-{{ persona.id }}">
        ‚õ≥ Solicitar baja
      </button>
    {% endif %}

    {% if persona.estatus_membresia == 'BAJA EN PROCESO' and has_role('admin','coordinador') %}
      <button
        type="button"
        class="btn btn-outline-secondary btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#modal-rechazar-baja-{{ persona.id }}">
        üö´ Rechazar baja
      </button>
    {% endif %}

    {% if has_role('admin', 'coordinador') %}
  <form action="{{ url_for('personal_bp.eliminar_personal', id=persona.id) }}"
        method="post" style="display:inline"
        onsubmit="return confirm('¬øEliminar este registro?');">
    {# Si luego configuras Flask-WTF, aqu√≠ pones: {{ csrf_token() }} #}
    <button type="submit" class="btn btn-outline-danger btn-sm">üóëÔ∏è</button>
  </form>
  {% endif %}
</div>
</div>
<small class="text-muted">{{ persona.funcion }}</small>
{# Badge fijo en esquina inferior derecha de la tarjeta #}
{% if persona.estatus_membresia == 'BAJA EN PROCESO' %}
  <span class="status-chip badge bg-warning text-dark">Baja en proceso</span>
{% endif %}

</div>
</div>

{# Modal Solicitar Baja (para esta persona) #}
<div class="modal fade" id="modal-solicitar-baja-{{ persona.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('personal_bp.solicitar_baja', id=persona.id) }}">
        <div class="modal-header">
          <h5 class="modal-title">Solicitar baja</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Trabajador: <strong>{{ persona.apellido_paterno }} {{ persona.apellido_materno }} {{ persona.nombre }}</strong><br>
            CCT: <strong>{{ persona.cct or persona.plantel.cct }}</strong>
          </p>
          <div class="mb-3">
            <label class="form-label">Motivo de la baja <span class="text-danger">*</span></label>
            <textarea name="motivo_baja" class="form-control" rows="4" required></textarea>
          </div>
          <div class="form-text">
            Se enviar√° notificaci√≥n al √°rea correspondiente y se registrar√° en el historial del trabajador.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-warning" type="submit">Enviar solicitud</button>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal Rechazar Baja #}
<div class="modal fade" id="modal-rechazar-baja-{{ persona.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('personal_bp.rechazar_baja', id=persona.id) }}">
        {# Si usas CSRF, agrega aqu√≠ {{ csrf_token() }} #}
        <div class="modal-header">
          <h5 class="modal-title">Rechazar solicitud de baja</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Trabajador: <strong>{{ persona.apellido_paterno }} {{ persona.apellido_materno }} {{ persona.nombre }}</strong><br>
            CCT: <strong>{{ persona.cct or persona.plantel.cct }}</strong>
          </p>
          <div class="mb-3">
            <label class="form-label">Motivo del rechazo <span class="text-danger">*</span></label>
            <textarea name="motivo_rechazo" class="form-control" rows="4" required></textarea>
          </div>
          <div class="form-text">
            Se registrar√° en el historial y se enviar√° una notificaci√≥n. El estatus volver√° a ACTIVO.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-warning" type="submit">Rechazar baja</button>
        </div>
      </form>
    </div>
  </div>
</div>


  {% endfor %}
</div>
<script>
  setTimeout(() => {
    const alerta = document.querySelector('.alert');
    if (alerta) {
      alerta.classList.remove('show');
      alerta.classList.add('fade');
      setTimeout(() => alerta.remove(), 2000);
    }
  }, 1500);
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
{% endblock %}
