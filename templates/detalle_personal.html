{% extends 'base.html' %}
{% block title %}Detalle del Personal{% endblock %}

{% import '_breadcrumbs.html' as bc %}
{% set pl = persona.plantel %}

{% block breadcrumbs %}
  {{ bc.render_breadcrumbs([
    ('Inicio', url_for('dashboard_bp.dashboard')),
    ('Delegaciones', url_for('delegaciones_bp.vista_delegaciones')),
    ( pl.delegacion.nombre if pl and pl.delegacion else 'Delegaci√≥n',
      url_for('delegaciones_bp.vista_delegaciones', delegacion_id=pl.delegacion_id) if pl and pl.delegacion_id else None),

    # üëá Este era el que fallaba: SIEMPRE como (label, None)
    ( (pl.nombre ~ ' (' ~ pl.cct ~ ')') if pl else (persona.cct or 'Plantel'), None),

    ( 'Personal',
      url_for('personal_bp.vista_personal',
              delegacion=(pl.delegacion.nombre if pl and pl.delegacion else ''),
              cct=(pl.cct if pl else persona.cct or '')) if (pl or persona.cct) else None ),

    ( (persona.apellido_paterno ~ ' ' ~ persona.apellido_materno ~ ' ' ~ persona.nombre)|trim, None )
  ]) }}
{% endblock %}

{% block content %}

{% macro campo(label, value) -%}
  <div class="col-md-4 mb-2">
    <small class="text-muted">{{ label }}</small>
    <div class="fw-semibold">{{ value if value not in (None, '') else '‚Äî' }}</div>
  </div>
{%- endmacro %}


<a href="{{ url_for('personal_bp.ver_historial', entidad='personal', id=persona.id) }}" class="btn btn-outline-secondary">
  üìú Ver historial de cambios
</a>


<a
  href="{{ url_for(
        'personal_bp.vista_personal',
        delegacion=(persona.plantel.delegacion.nombre if persona.plantel and persona.plantel.delegacion else ''),
        cct=persona.cct
  ) }}"
  class="btn btn-secondary">
  ‚¨ÖÔ∏è Regresar a Personal
</a>


<a href="{{ url_for('dashboard_bp.dashboard') }}" class="btn btn-secondary">
  ‚¨ÖÔ∏è Regresar al Men√∫ principal
</a>

<div class="container mt-4">

  <h4 class="mb-3">Detalle del personal: <strong>{{ persona.apellido_paterno }} {{ persona.apellido_materno }} {{ persona.nombre }}</strong></h4>

  {# ‚úÖ Versi√≥n segura (usa persona.plantel y valida None) #}
  {% set pl = persona.plantel %}
  {% if pl %}
    <div class="alert alert-secondary py-2">
      <div><strong>Plantel: </strong>{{ pl.nombre }} ({{ pl.cct }})</div>
      <div><small>{{ pl.calle }} {{ pl.num_exterior }} {{ pl.colonia }}, {{ pl.municipio }}, C.P. {{ pl.cp }}</small></div>
    </div>
    <div class="list-group-item">
      <p><strong>CCT de adscripci√≥n:</strong> {{ persona.cct }} ‚Äì {{ pl.nombre }}</p>
    </div>
  {% else %}
    <div class="alert alert-warning py-2 mb-2">
      No hay plantel asociado a este registro (CCT: {{ persona.cct or '‚Äî' }}).
    </div>
  {% endif %}


  </div>

  <div class="d-flex gap-2 mt-2">
  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal-editar-personal">
    ‚úèÔ∏è Editar
  </button>

  {% if has_role('admin', 'coordinador') %}
  <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modal-cambio-adscripcion">
    üîÑ Cambio de adscripci√≥n
  </button>
  {% endif %}
</div>

<div class="d-flex gap-2 mt-2">
  <a class="btn btn-outline-success btn-sm" href="{{ url_for('personal_bp.ficha_persona_excel', persona_id=persona.id) }}">
    üìä Descargar ficha (Excel)
  </a>
  <a class="btn btn-outline-danger btn-sm" href="{{ url_for('personal_bp.ficha_persona_pdf', persona_id=persona.id) }}">
    üßæ Descargar ficha (PDF)
  </a>
</div>


  <!-- Lista de datos -->
  <!-- ===== Detalle en bloques (v2) ===== -->
<h5 class="mt-4">Identificaci√≥n</h5>
<div class="row">
  {{ campo('NUM', persona.num) }}
  {{ campo('Paterno', persona.apellido_paterno) }}
  {{ campo('Materno', persona.apellido_materno) }}
  {{ campo('Nombre', persona.nombre) }}
  {{ campo('G√©nero', persona.genero) }}
  {{ campo('RFC', persona.rfc) }}
  {{ campo('CURP', persona.curp) }}
  {{ campo('Clave presupuestal', persona.clave_presupuestal) }}
  {{ campo('Funci√≥n', persona.funcion) }}
  {{ campo('Grado m√°ximo estudios', persona.grado_estudios) }}
  {{ campo('Titulado', persona.titulado) }}
  {{ campo('Fecha ingreso', persona.fecha_ingreso) }}
  {{ campo('Fecha baja/jub', persona.fecha_baja_jubilacion) }}
  {{ campo('Estatus membres√≠a', persona.estatus_membresia) }}
  {{ campo('Nombramiento', persona.nombramiento) }}
</div>

<h5 class="mt-4">Domicilio (persona)</h5>
<div class="row">
  {{ campo('DP_CALLE', persona.domicilio) }}      {# v2 DP_CALLE ‚Üí campo BD 'domicilio' #}
  {{ campo('DP_NUM_EXT', persona.numero) }}       {# v2 DP_NUM_EXT ‚Üí 'numero'          #}
  {{ campo('DP_NUM_INT', persona.dp_num_int) }}
  {{ campo('DP_CRUCE1', persona.dp_cruce1) }}
  {{ campo('DP_CRUCE2', persona.dp_cruce2) }}
  {{ campo('DP_LOCALIDAD', persona.localidad) }}
  {{ campo('DP_COLONIA', persona.colonia) }}
  {{ campo('DP_MUN_NOM', persona.municipio) }}
  {{ campo('DP_CP', persona.cp) }}
  {{ campo('DP_TEL1', persona.tel1) }}
  {{ campo('DP_TEL2', persona.tel2) }}
  {{ campo('CORREO_ELECTRONICO', persona.correo_electronico) }}
</div>

<h5 class="mt-4">Datos de la escuela </h5>
<div class="row">
  {{ campo('ESCUELA_NOMBRE', persona.escuela_nombre) }}
  {{ campo('CCT', persona.cct) }}
  {{ campo('TURNO', persona.turno) }}
  {{ campo('NIVEL', persona.nivel) }}
  {{ campo('SUBS_MODALIDAD', persona.subs_modalidad) }}
  {{ campo('ZONA_ESCOLAR', persona.zona_escolar) }}
  {{ campo('SECTOR', persona.sector) }}
</div>

<h5 class="mt-4">Domicilio de la escuela</h5>
<div class="row">
  {{ campo('DOM_ESC_CALLE', persona.dom_esc_calle) }}
  {{ campo('DOM_ESC_NUM_EXT', persona.dom_esc_num_ext) }}
  {{ campo('DOM_ESC_NUM_INT', persona.dom_esc_num_int) }}
  {{ campo('DOM_ESC_CRUCE1', persona.dom_esc_cruce1) }}
  {{ campo('DOM_ESC_CRUCE2', persona.dom_esc_cruce2) }}
  {{ campo('DOM_ESC_LOCALIDAD', persona.dom_esc_localidad) }}
  {{ campo('DOM_ESC_COLONIA', persona.dom_esc_colonia) }}
  {{ campo('DOM_ESC_MUN_NOM', persona.dom_esc_mun_nom) }}
  {{ campo('DOM_ESC_CP', persona.dom_esc_cp) }}
  {{ campo('DOM_ESC_COORDENADAS GPS', persona.dom_esc_coordenadas_gps) }}
</div>

<h5 class="mt-4">Otros</h5>
<div class="row">
  {{ campo('ESTADO', persona.estado) }}
  {{ campo('SECCION_SNTE', persona.seccion_snte) }}
  {{ campo('DEL_O_CT', persona.del_o_ct) }}
  {{ campo('ORG', persona.org) }}
  {{ campo('COORD_REG', persona.coord_reg) }}
  {{ campo('FUN_SIN', persona.fun_sin) }}
</div>



</div>

<hr>
<h5>Observaciones registradas</h5>

<!-- Formulario para agregar nueva -->
<form method="POST" action="{{ url_for('personal_bp.agregar_observacion', personal_id=persona.id) }}" class="mb-3">
  <div class="input-group">
    <textarea name="texto" class="form-control" placeholder="Escribe una observaci√≥n..." required></textarea>
    <button class="btn btn-outline-primary" type="submit">‚ûï Agregar</button>
  </div>
</form>



<!-- Lista de observaciones -->
<div style="max-height: 300px; overflow-y: auto;">
  {% for obs in persona.observaciones %}
    <style>
      .obs-adscripcion { background-color: #ff6a00; color: white; }
    </style>

    <div class="border rounded p-2 mb-2 small position-relative
                {{ 'obs-adscripcion' if 'Motivo de cambio de adscripci√≥n:' in (obs.texto or '') else 'bg-light' }}">



      <strong>{{ usuarios_por_id[obs.usuario_id].nombre if obs.usuario_id in usuarios_por_id else 'Usuario' }}</strong>
      <em class="text-muted">({{ obs.fecha.strftime('%d/%m/%Y %H:%M') }})</em><br>

      {% if current_user.rol == 'admin' %}
  <div class="d-flex align-items-start gap-2">
    
    <!-- Formulario para editar -->
    <form method="POST" action="{{ url_for('personal_bp.editar_observacion', obs_id=obs.id) }}">
      <div class="d-flex align-items-start gap-2">
        <textarea name="nuevo_texto" class="form-control form-control-sm" rows="2" style="width: 1100px;">{{ obs.texto }}</textarea>
        <button class="btn btn-sm btn-success mt-1" type="submit" title="Guardar">üíæ</button>
      </div>
    </form>

    <!-- Formulario para eliminar -->
    <form method="POST" action="{{ url_for('personal_bp.eliminar_observacion', obs_id=obs.id) }}" onsubmit="return confirm('¬øEliminar esta observaci√≥n?')">
      <button class="btn btn-sm btn-danger mt-1" type="submit" title="Eliminar">üóëÔ∏è</button>
    </form>

  </div>
{% else %}
  {{ obs.texto }}
{% endif %}

    </div>

  {% else %}
    <p class="text-muted">Sin observaciones registradas.</p>
  {% endfor %}
</div>


<!-- Modal de edici√≥n -->
<div class="modal fade" id="modal-editar-personal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('personal_bp.editar_personal', id=persona.id) }}">
        <!-- üîí Siempre mandar el CCT actual -->
        <input type="hidden" name="cct" value="{{ persona.cct }}">

        <div class="modal-header">...</div>

        <div class="modal-body">
          <div class="row g-2">

            <!-- üëá Aqu√≠ el campo SOLO LECTURA para mostrar el CCT -->
            <div class="col-md-4">
              <label class="form-label">CCT de adscripci√≥n</label>
              <input
                type="text"
                class="form-control"
                value="{{ persona.cct }}{% if persona.plantel %} ‚Äî {{ persona.plantel.nombre }}{% endif %}"
                readonly>
            </div>
            
            {% for label, name, type, value, options in [
              ('Apellido paterno', 'apellido_paterno', 'text', persona.apellido_paterno, None),
              ('Apellido materno', 'apellido_materno', 'text', persona.apellido_materno, None),
              ('Nombre(s)', 'nombre', 'text', persona.nombre, None),
              ('G√©nero', 'genero', 'select', persona.genero, [('H', 'H'), ('M', 'M')]),
              ('RFC', 'rfc', 'text', persona.rfc, None),
              ('CURP', 'curp', 'text', persona.curp, None),
              ('Clave presupuestal', 'clave_presupuestal', 'text', persona.clave_presupuestal, None),
              ('Funci√≥n', 'funcion', 'text', persona.funcion, None),
              ('Grado m√°ximo de estudios', 'grado_estudios', 'text', persona.grado_estudios, None),
              ('Titulado', 'titulado', 'select', persona.titulado, [('T√çTULO', 'T√çTULO'), ('No Titulado', 'No Titulado'), ('N/A', 'N/A')]),
              ('Fecha de ingreso', 'fecha_ingreso', 'date', persona.fecha_ingreso, None),
              ('Fecha baja por jubilaci√≥n', 'fecha_baja_jubilacion', 'date', persona.fecha_baja_jubilacion, None),
              ('Estatus de membres√≠a', 'estatus_membresia', 'select', persona.estatus_membresia, [('ACTIVO', 'ACTIVO'), ('INACTIVO', 'INACTIVO')]),
              ('Nombramiento', 'nombramiento', 'text', persona.nombramiento, None),
              ('Domicilio (DP_CALLE)', 'domicilio', 'text', persona.domicilio, None),
              ('N√∫mero exterior (DP_NUM_EXT)', 'numero', 'text', persona.numero, None),
              ('Localidad (DP_LOCALIDAD)', 'localidad', 'text', persona.localidad, None),
              ('Colonia (DP_COLONIA)', 'colonia', 'text', persona.colonia, None),
              ('Municipio (DP_MUN_NOM)', 'municipio', 'text', persona.municipio, None),
              ('C.P. (DP_CP)', 'cp', 'text', persona.cp, None),
              ('Tel√©fono 1 (DP_TEL1)', 'tel1', 'text', persona.tel1, None),
              ('Tel√©fono 2 (DP_TEL2)', 'tel2', 'text', persona.tel2, None),
              ('Correo electr√≥nico', 'correo_electronico', 'email', persona.correo_electronico, None),

            
              ('NUM', 'num', 'text', persona.num, None),
              ('N√∫mero interior (DP_NUM_INT)', 'dp_num_int', 'text', persona.dp_num_int, None),
              ('Cruce 1 (DP_CRUCE1)', 'dp_cruce1', 'text', persona.dp_cruce1, None),
              ('Cruce 2 (DP_CRUCE2)', 'dp_cruce2', 'text', persona.dp_cruce2, None),

              ('Escuela nombre', 'escuela_nombre', 'text', persona.escuela_nombre, None),
              ('Turno', 'turno', 'text', persona.turno, None),
              ('Nivel', 'nivel', 'text', persona.nivel, None),
              ('Subsistema / modalidad', 'subs_modalidad', 'text', persona.subs_modalidad, None),
              ('Zona escolar', 'zona_escolar', 'text', persona.zona_escolar, None),
              ('Sector', 'sector', 'text', persona.sector, None),

              ('DOM_ESC_CALLE', 'dom_esc_calle', 'text', persona.dom_esc_calle, None),
              ('DOM_ESC_NUM_EXT', 'dom_esc_num_ext', 'text', persona.dom_esc_num_ext, None),
              ('DOM_ESC_NUM_INT', 'dom_esc_num_int', 'text', persona.dom_esc_num_int, None),
              ('DOM_ESC_CRUCE1', 'dom_esc_cruce1', 'text', persona.dom_esc_cruce1, None),
              ('DOM_ESC_CRUCE2', 'dom_esc_cruce2', 'text', persona.dom_esc_cruce2, None),
              ('DOM_ESC_LOCALIDAD', 'dom_esc_localidad', 'text', persona.dom_esc_localidad, None),
              ('DOM_ESC_COLONIA', 'dom_esc_colonia', 'text', persona.dom_esc_colonia, None),
              ('DOM_ESC_MUN_NOM', 'dom_esc_mun_nom', 'text', persona.dom_esc_mun_nom, None),
              ('DOM_ESC_CP', 'dom_esc_cp', 'text', persona.dom_esc_cp, None),
              ('DOM_ESC_COORDENADAS GPS', 'dom_esc_coordenadas_gps', 'text', persona.dom_esc_coordenadas_gps, None),

              ('Estado', 'estado', 'text', persona.estado, None),
              ('Secci√≥n SNTE', 'seccion_snte', 'text', persona.seccion_snte, None),
              ('Del o CT', 'del_o_ct', 'text', persona.del_o_ct, None),
              ('Org', 'org', 'text', persona.org, None),
              ('Coordinaci√≥n regional', 'coord_reg', 'text', persona.coord_reg, None),
              ('Funci√≥n sindical', 'fun_sin', 'text', persona.fun_sin, None),
            ] %}
              <div class="col-md-4">
                <label class="form-label">{{ label }}</label>
                {% if type == 'select' %}
                  <select class="form-select" name="{{ name }}">
                    {% if not value %}
                      <option value="">Seleccionar</option>
                    {% endif %}
                    {% for val, text in options %}
                      <option value="{{ val }}" {% if value == val %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                  </select>
                {% elif name == 'curp' %}
                  <input type="text" name="curp" value="{{ value }}" class="form-control text-uppercase"
                        oninput="this.value=this.value.toUpperCase()"
                        pattern="^[A-Z]{4}\d{6}[HM][A-Z]{5}[0-9A-Z]\d$"
                        title="CURP inv√°lido. Debe tener 18 caracteres, en may√∫sculas." required>


                {% elif name == 'rfc' %}
                  <input type="text" name="rfc" value="{{ value }}" class="form-control text-uppercase"
                        oninput="this.value=this.value.toUpperCase()"
                        pattern="^[A-Z√ë&]{3,4}\d{6}[A-Z0-9]{2,3}$"
                        title="RFC inv√°lido (12 o 13 caracteres, may√∫sculas)." required>

{% else %}
  <input type="{{ type }}" name="{{ name }}" value="{{ value }}" class="form-control">
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">üíæ Guardar cambios</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if has_role('admin', 'coordinador') %}
<div class="modal fade" id="modal-cambio-adscripcion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST"
            action="{{ url_for('personal_bp.editar_personal', id=persona.id) }}"
            novalidate>   

        <div class="modal-header">
          <h5 class="modal-title">Cambio de adscripci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nivel" class="form-label">Selecciona nivel educativo:</label>
            <select id="nivel" name="nivel" class="form-select" required>
              <option value="">Seleccionar</option>
              {% for nivel in niveles_disponibles %}
                <option value="{{ nivel }}">{{ nivel }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="nuevo_cct" class="form-label">Selecciona nuevo CCT:</label>
            <select id="nuevo_cct" name="nuevo_cct" class="form-select" required>
              <option value="">Selecciona primero un nivel</option>
            </select>
            <div class="mb-3">
              <label for="motivo" class="form-label">Motivo del cambio:</label>
              <textarea id="motivo" name="motivo" class="form-control" rows="3" required placeholder="Ejemplo: Reasignaci√≥n por necesidades del servicio."></textarea>
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">üíæ Confirmar cambio</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}


<script>
  const endpoint = "{{ url_for('personal_bp.obtener_ccts_por_nivel') }}";

  document.addEventListener("DOMContentLoaded", () => {
    const nivelSelect = document.getElementById("nivel");
    const cctSelect = document.getElementById("nuevo_cct");

    nivelSelect.addEventListener("change", async () => {
      const nivel = nivelSelect.value;
      cctSelect.innerHTML = '<option value="">Cargando CCTs...</option>';

      if (!nivel) {
        cctSelect.innerHTML = '<option value="">Selecciona primero un nivel</option>';
        return;
      }

      try {
        const response = await fetch(`${endpoint}?nivel=${encodeURIComponent(nivel)}`);
        const data = await response.json();

        if (data.length === 0) {
          cctSelect.innerHTML = '<option value="">No se encontraron CCTs</option>';
        } else {
          cctSelect.innerHTML = '<option value="">Selecciona un CCT</option>';
          data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.cct;
            option.textContent = `${item.cct} ‚Äì ${item.nombre}`;
            cctSelect.appendChild(option);
          });
        }
      } catch (error) {
        cctSelect.innerHTML = '<option value="">Error al cargar CCTs</option>';
      }
    });
  });
</script>


{% endblock %}
